<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Geological Compass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .header {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .data-display {
            background-color: #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .data-label {
            font-size: 1rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 2rem;
            font-weight: 600;
            color: #556B2F; /* Dark Olive Green */
        }

        .btn {
            background-color: #556B2F; /* Dark Olive Green */
            color: #fff;
            padding: 15px 25px;
            border-radius: 10px;
            border: none;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px #3C4B22;
            width: 100%;
        }
        
        .btn:hover {
            background-color: #6a823d;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px #3C4B22;
        }

        .btn:disabled {
            background-color: #5a5a5a;
            box-shadow: 0 4px #2a2a2a;
            cursor: not-allowed;
            transform: none;
        }

        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4a4a4a;
            color: #fff;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }

        .message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">Geological Compass</div>
        
        <div class="data-display">
            <div class="data-label">Strike</div>
            <div id="strike-display" class="data-value">---</div>
        </div>

        <div class="data-display">
            <div class="data-label">Dip</div>
            <div id="dip-display" class="data-value">---</div>
        </div>
        
        <div class="data-display">
            <div class="data-label">Dip Direction</div>
            <div id="dip-direction-display" class="data-value">---</div>
        </div>

        <button id="measure-btn" class="btn">Measure</button>
    </div>

    <div id="message-box" class="message-box"></div>

    <script>
        // Global variables for sensor data and state
        let currentAlpha = null;
        let currentBeta = null;
        let currentGamma = null;
        let permissionsRequested = false;

        // Cache DOM elements
        const strikeDisplay = document.getElementById('strike-display');
        const dipDisplay = document.getElementById('dip-display');
        const dipDirectionDisplay = document.getElementById('dip-direction-display');
        const measureBtn = document.getElementById('measure-btn');

        // Function to show a temporary notification message
        function showMessage(message) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.classList.add('show');
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, 3000);
        }

        // Helper function to format compass direction
        function formatCompassDirection(degrees) {
            if (degrees < 0) degrees += 360;
            let formattedValue = '';
            if (degrees > 337.5 || degrees <= 22.5) {
                formattedValue = `N`;
            } else if (degrees > 22.5 && degrees <= 67.5) {
                formattedValue = `N${Math.round(degrees)}E`;
            } else if (degrees > 67.5 && degrees <= 112.5) {
                formattedValue = `E`;
            } else if (degrees > 112.5 && degrees <= 157.5) {
                formattedValue = `S${Math.round(180 - degrees)}E`;
            } else if (degrees > 157.5 && degrees <= 202.5) {
                formattedValue = `S`;
            } else if (degrees > 202.5 && degrees <= 247.5) {
                formattedValue = `S${Math.round(degrees - 180)}W`;
            } else if (degrees > 247.5 && degrees <= 292.5) {
                formattedValue = `W`;
            } else if (degrees > 292.5 && degrees <= 337.5) {
                formattedValue = `N${Math.round(360 - degrees)}W`;
            }
            return formattedValue;
        }

        // Check for device orientation and motion support on mobile
        function hasSensorSupport() {
            return (window.DeviceOrientationEvent && 'ondeviceorientation' in window) && (window.DeviceMotionEvent && 'ondevicemotion' in window);
        }

        // Start device sensor listeners only after permission is granted
        function startListeners() {
            window.addEventListener('deviceorientation', handleOrientation);
            window.addEventListener('devicemotion', handleMotion);
        }

        // Request permissions for iOS 13+ and start listeners on success
        async function requestSensorPermissions() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function' && !permissionsRequested) {
                try {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState === 'granted') {
                        permissionsRequested = true;
                        startListeners();
                        return true;
                    } else {
                        showMessage('Permission to access sensors was denied. Please grant permission in your browser settings.');
                        return false;
                    }
                } catch (error) {
                    console.error('Permission request failed:', error);
                    showMessage('Permission request failed. Please check your browser settings.');
                    return false;
                }
            } else {
                // For Android or older iOS, just start listeners
                startListeners();
                return true;
            }
        }
        
        // Handle device orientation events for compass
        function handleOrientation(event) {
            const alpha = event.webkitCompassHeading || event.alpha;
            if (alpha !== null) {
                currentAlpha = alpha;
            }
        }

        // Handle device motion events for tilt (dip)
        function handleMotion(event) {
            currentBeta = event.beta;
            currentGamma = event.gamma;
        }

        // Event listener for the single measure button
        measureBtn.addEventListener('click', async () => {
            if (!hasSensorSupport()) {
                showMessage('Your device does not support the necessary sensors.');
                return;
            }

            if (!permissionsRequested) {
                const isGranted = await requestSensorPermissions();
                if (!isGranted) {
                    return;
                }
            }

            // After permission is granted, wait a moment for sensor data to populate
            await new Promise(resolve => setTimeout(resolve, 500));

            if (currentAlpha === null || isNaN(currentAlpha)) {
                showMessage('Compass data not available. Please try again.');
                return;
            }

            if (currentBeta === null || isNaN(currentBeta)) {
                showMessage('Tilt data not available. Please try again or check device permissions.');
                return;
            }

            const strikeValue = Math.round(currentAlpha);
            let dipValue = Math.round(currentBeta);
            let dipDirectionValue = Math.round(currentAlpha);

            // Correct the dip value for cases where the device is held horizontally or upside down
            if (dipValue > 90) {
                dipValue = 180 - dipValue;
                // Reverse the dip direction if the device is upside down
                dipDirectionValue = (dipDirectionValue + 180) % 360;
            } else if (dipValue < -90) {
                dipValue = -180 - dipValue;
                dipDirectionValue = (dipDirectionValue + 180) % 360;
            }

            // Ensure dip value is positive
            dipValue = Math.abs(dipValue);

            strikeDisplay.textContent = `${formatCompassDirection(strikeValue)} (${strikeValue}°)`;
            dipDisplay.textContent = `${dipValue}°`;
            dipDirectionDisplay.textContent = `${formatCompassDirection(dipDirectionValue)} (${dipDirectionValue}°)`;

            showMessage('Measurements captured!');
        });
        
    </script>
</body>
</html>
